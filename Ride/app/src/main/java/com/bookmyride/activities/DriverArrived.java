package com.bookmyride.activities;import android.Manifest;import android.animation.ValueAnimator;import android.app.AlertDialog;import android.app.Dialog;import android.content.ActivityNotFoundException;import android.content.BroadcastReceiver;import android.content.Context;import android.content.DialogInterface;import android.content.Intent;import android.content.IntentFilter;import android.content.pm.PackageInfo;import android.content.pm.PackageManager;import android.graphics.Color;import android.graphics.drawable.ColorDrawable;import android.location.Location;import android.net.Uri;import android.os.AsyncTask;import android.os.Build;import android.os.Bundle;import android.os.Handler;import android.os.SystemClock;import android.support.annotation.NonNull;import android.support.annotation.Nullable;import android.support.v4.app.ActivityCompat;import android.support.v4.content.ContextCompat;import android.support.v4.content.LocalBroadcastManager;import android.support.v7.app.AppCompatActivity;import android.support.v7.widget.CardView;import android.util.Log;import android.view.LayoutInflater;import android.view.MotionEvent;import android.view.View;import android.view.Window;import android.view.WindowManager;import android.view.animation.Interpolator;import android.view.animation.LinearInterpolator;import android.widget.AdapterView;import android.widget.ArrayAdapter;import android.widget.EditText;import android.widget.ImageView;import android.widget.LinearLayout;import android.widget.ListView;import android.widget.RelativeLayout;import android.widget.SeekBar;import android.widget.TextView;import android.widget.Toast;import com.google.android.gms.common.ConnectionResult;import com.google.android.gms.common.api.GoogleApiClient;import com.google.android.gms.location.LocationListener;import com.google.android.gms.location.LocationRequest;import com.google.android.gms.location.LocationServices;import com.google.android.gms.maps.CameraUpdate;import com.google.android.gms.maps.CameraUpdateFactory;import com.google.android.gms.maps.GoogleMap;import com.google.android.gms.maps.OnMapReadyCallback;import com.google.android.gms.maps.SupportMapFragment;import com.google.android.gms.maps.model.BitmapDescriptorFactory;import com.google.android.gms.maps.model.CameraPosition;import com.google.android.gms.maps.model.LatLng;import com.google.android.gms.maps.model.LatLngBounds;import com.google.android.gms.maps.model.Marker;import com.google.android.gms.maps.model.MarkerOptions;import com.google.android.gms.maps.model.Polyline;import com.google.android.gms.maps.model.PolylineOptions;import com.google.maps.android.PolyUtil;import com.bookmyride.R;import com.bookmyride.api.APIHandler;import com.bookmyride.api.APIStatus;import com.bookmyride.api.AsyncTaskCompleteListener;import com.bookmyride.api.Config;import com.bookmyride.api.HTTPMethods;import com.bookmyride.api.Key;import com.bookmyride.common.Internet;import com.bookmyride.common.SessionHandler;import com.bookmyride.fcm.NotificationFilters;import com.bookmyride.fcm.NotificationUtils;import com.bookmyride.map.DirectionsJSONParser;import com.bookmyride.util.LatLngInterpolator;import com.bookmyride.util.Utils;import com.romainpiel.shimmer.Shimmer;import com.romainpiel.shimmer.ShimmerButton;import org.json.JSONException;import org.json.JSONObject;import java.io.BufferedReader;import java.io.IOException;import java.io.InputStream;import java.io.InputStreamReader;import java.net.HttpURLConnection;import java.net.URL;import java.util.ArrayList;import java.util.HashMap;import java.util.List;public class DriverArrived extends AppCompatActivity        implements View.OnTouchListener, AsyncTaskCompleteListener,        SeekBar.OnSeekBarChangeListener, OnMapReadyCallback,        GoogleApiClient.ConnectionCallbacks,        GoogleApiClient.OnConnectionFailedListener, LocationListener {    //TrackGPS gps;    double latitude, longitude;    GoogleMap googleMap;    SeekBar sliderSeekBar;    ShimmerButton slider;    Shimmer shimmer;    String bookingId, passengerName, passengerPhone;    SessionHandler session;    String puLat = "0.0", puLng = "0.0", puAddres;    TextView rideId, name, /*mobile,*/            pmtStatus, reCall;    private BroadcastReceiver mReceiver;    LinearLayout layContact;    String driverLat = "", driverLng = "";    private LatLng fromPosition;    private LatLng toPosition;    LocationRequest mLocationRequest;    GoogleApiClient mGoogleApiClient;    APIHandler apiHandler;    Marker mCurrLocationMarker;    String driverCategory;    String bookingType, paymentStatus, noteMsg, cardValid = "";    CardView cardInfo;    ImageView iconGPS, note;    TextView puAddress, noteMessage, noteClose;    RelativeLayout layNote;    private static final long INTERVAL = 1000 * 10;    private static final long FASTEST_INTERVAL = 1000 * 5;    public void onInfo(View view) {    }    @Override    protected void onCreate(@Nullable Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.driver_arrived);        getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);        String pickup = getIntent().getStringExtra("pickUp");        try {            JSONObject puObj = new JSONObject(pickup);            puAddres = puObj.getString("address");            puLat = puObj.getString("lat");            puLng = puObj.getString("lng");        } catch (JSONException e) {            e.printStackTrace();        }        //buildGoogleApiClient();        initGoogleAPIClient();        init();        puAddress.setText(puAddres);        driverCategory = getIntent().getStringExtra("driverCategory");        updateSliderUI();        /*if (gps.canGetLocation()) {            latitude = gps.getLatitude();            longitude = gps.getLongitude();        }*/        bookingId = getIntent().getStringExtra("bookingId");        passengerName = getIntent().getStringExtra("passenger_name");        passengerPhone = getIntent().getStringExtra("passenger_phone");        rideId.setText("RIDE_ID: " + bookingId);        name.setText("Passenger: " + passengerName);        //mobile.setText(passengerPhone);        //mobile.setText("Contact Passenger");        paymentStatus = getIntent().getStringExtra("payment_status");        bookingType = getIntent().getStringExtra("type");        if (paymentStatus.equals("1")) {            float scale = getResources().getDisplayMetrics().density;            int dpAsPixels = (int) (10 * scale + 0.5f);            pmtStatus.setPadding(dpAsPixels, dpAsPixels, dpAsPixels, dpAsPixels);            pmtStatus.setVisibility(View.VISIBLE);        } else pmtStatus.setVisibility(View.GONE);        getDriverGEO();    }    float zoomLevel = 15;    private void getDriverGEO() {        type = 2;        if (Internet.hasInternet(this)) {            APIHandler apiHandler = new APIHandler(this, HTTPMethods.GET, this, null);            apiHandler.execute(Config.DRIVER_GEO + bookingId + "?expand=drivergeo,passanger", session.getToken());        } else            Error("Alert!", getResources().getString(R.string.no_internet));    }    private void getTwillioNumber() {        if (Internet.hasInternet(this)) {            APIHandler apiHandler = new APIHandler(this, HTTPMethods.GET, new AsyncTaskCompleteListener() {                @Override                public void onTaskComplete(String result) {                    try {                        JSONObject object = new JSONObject(result);                        if (object.getInt(Key.STATUS) == APIStatus.SUCCESS) {                            JSONObject dataObj = object.getJSONObject(Key.DATA);                            passengerPhone = dataObj.getString("twilio_number");                            callPassenger();                        } else if (object.getInt(Key.STATUS) == APIStatus.UNPROCESSABLE) {                            Alert("Alert!", object.getString(Key.MESSAGE));                        } else {                            Alert("Alert!", object.getString(Key.MESSAGE));                        }                    } catch (JSONException e) {                        e.printStackTrace();                    }                }            }, null);            apiHandler.execute(Config.GET_TWILLIO_NUMBER + bookingId, session.getToken());        } else            Alert("Alert!", getResources().getString(R.string.no_internet));    }    String msg = "";    private void init() {        session = new SessionHandler(this);        //gps = new TrackGPS(this);        rideId = (TextView) findViewById(R.id.ride_id);        name = (TextView) findViewById(R.id.name);        cardInfo = (CardView) findViewById(R.id.lay_info);        //mobile = (TextView) findViewById(R.id.mobile);        pmtStatus = (TextView) findViewById(R.id.payment_status);        layNote = (RelativeLayout) findViewById(R.id.lay_note);        noteMessage = (TextView) findViewById(R.id.note_msg);        noteClose = (TextView) findViewById(R.id.note_close);        noteClose.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                layNote.setVisibility(View.GONE);            }        });        note = (ImageView) findViewById(R.id.note);        note.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                //showNote("Pick-Up Notes", noteMsg);                if (layNote.getVisibility() == View.VISIBLE)                    layNote.setVisibility(View.GONE);                else layNote.setVisibility(View.VISIBLE);            }        });        iconGPS = (ImageView) findViewById(R.id.gps);        iconGPS.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                if (!puLat.equals("0.0") && !puLng.equals("0.0") &&                        !puLng.equals("null") && !puLng.equals("null")) {                    double pu_lat = Double.parseDouble(puLat);                    double pu_lng = Double.parseDouble(puLng);                    LatLng coordinate = new LatLng(pu_lat, pu_lng);                    CameraUpdate location = CameraUpdateFactory.newLatLngZoom(                            coordinate, googleMap.getCameraPosition().zoom);                    googleMap.animateCamera(location);                }            }        });        puAddress = (TextView) findViewById(R.id.pu_address);        reCall = (TextView) findViewById(R.id.recall);        reCall.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                Prompt("Alert!", "Are you sure you want to recall this ride?");            }        });        layContact = (LinearLayout) findViewById(R.id.lay_contact);        layContact.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                showRideDialog();            }        });        sliderSeekBar = (SeekBar) findViewById(R.id.begin_Trip_seek);        slider = (ShimmerButton) findViewById(R.id.begin_Trip_slider_button);        //Rl_beginTrip = (RelativeLayout) findViewById(R.id.layout_begintrip);        initSlider();        mReceiver = new BroadcastReceiver() {            @Override            public void onReceive(Context context, Intent intent) {                if (intent.getAction().equals(NotificationFilters.REQUEST_CANCELLED)) {                    if (session.getUserType().equals("4")) {                        try {                            JSONObject obj = new JSONObject(intent.getStringExtra("rideData"));                            msg = obj.getString("message");                            new Handler().postDelayed(new Runnable() {                                @Override                                public void run() {                                    Utils.showPopup(DriverArrived.this, msg);                                }                            }, 500);                        } catch (JSONException e) {                            e.printStackTrace();                        }                    }                } /*else if (intent.getAction().equals(NotificationFilters.LOCATION_CHANGED)) {                    double lat = intent.getDoubleExtra("lat", 0.0);                    double lng = intent.getDoubleExtra("lng", 0.0);                    latitude = lat;                    longitude = lng;                    driverLat = "" + latitude;                    driverLng = "" + longitude;                    LatLng latLng = new LatLng(latitude, longitude);                    if (googleMap != null) {                        if (mCurrLocationMarker == null) {                            drawMarker(latLng);                        } else {                            updateMarker(latLng);                            //googleMap.moveCamera(CameraUpdateFactory.newLatLng(latLng));                            zoomLevel = googleMap.getCameraPosition().zoom;                            if(zoomLevel < 12)                                zoomLevel = 15;                            CameraUpdate loc = CameraUpdateFactory.newLatLngZoom(                                    latLng, zoomLevel);                            googleMap.moveCamera(loc);                        }                    }                    if (line == null && googleMap != null) {                        drawRoute();                    }                }*/            }        };        cardInfo.setCardElevation(5);        cardInfo.setMaxCardElevation(6);        cardInfo.setRadius(0);    }    private void initSlider() {        shimmer = new Shimmer();        shimmer.start(slider);        sliderSeekBar.setOnSeekBarChangeListener(this);    }    private void initializeMap() {        if (googleMap == null) {            SupportMapFragment mapFragment = (SupportMapFragment) getSupportFragmentManager()                    .findFragmentById(R.id.map);            try {                mapFragment.getMapAsync(this);            } catch (NullPointerException e) {                e.printStackTrace();            }        }    }    @Override    public void onMapReady(GoogleMap map) {        googleMap = map;        // Move the camera to last position with a zoom level        CameraPosition cameraPosition = new CameraPosition.Builder().target(new LatLng(latitude, longitude)).build();        googleMap.moveCamera(CameraUpdateFactory.newCameraPosition(cameraPosition));        if (ContextCompat.checkSelfPermission(this,                Manifest.permission.ACCESS_FINE_LOCATION)                == PackageManager.PERMISSION_GRANTED) {            googleMap.setMyLocationEnabled(false);            googleMap.getUiSettings().setMyLocationButtonEnabled(false);        }        //Initialize Google Play Services        //initGoogleAPIClient();        driverLat = "" + latitude;        driverLng = "" + longitude;        drawRoute();    }    //Initializing Google Play Services    private void initGoogleAPIClient() {        if (android.os.Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {            if (ContextCompat.checkSelfPermission(this,                    Manifest.permission.ACCESS_FINE_LOCATION)                    == PackageManager.PERMISSION_GRANTED) {                buildGoogleApiClient();            }        } else {            buildGoogleApiClient();        }    }    private void showReCallDialog() {        LayoutInflater inflater = LayoutInflater.from(DriverArrived.this);        View subView = inflater.inflate(R.layout.recall_dialog, null);        final EditText reason = (EditText) subView.findViewById(R.id.reason);        TextView proceed = (TextView) subView.findViewById(R.id.send);        TextView cancel = (TextView) subView.findViewById(R.id.cancel);        AlertDialog.Builder builder = new AlertDialog.Builder(DriverArrived.this);        builder.setView(subView);        final AlertDialog alertDialog = builder.create();        proceed.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                if (reason.getText().length() > 0) {                    alertDialog.dismiss();                    submitRecallReason(reason.getText().toString());                } else                    Alert("Alert!", "Please enter the reason");            }        });        cancel.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                alertDialog.dismiss();                String msg = "Your recall request has been updated successfully. Ride is available for other drivers now.";                Alert("Success!", msg);            }        });        alertDialog.show();    }    private void reCall(String reason) {        type = 3;        HashMap<String, String> params = new HashMap<String, String>();        params.put("status", "11");        params.put("msg", reason);        APIHandler apiHandler = new APIHandler(this, HTTPMethods.PUT, this, params);        apiHandler.execute(Config.BOOKING_STATUS + bookingId, session.getToken());    }    private void submitRecallReason(String reason) {        type = 4;        HashMap<String, String> params = new HashMap<String, String>();        params.put("status", "13");        params.put("msg", reason);        APIHandler apiHandler = new APIHandler(this, HTTPMethods.PUT, this, params);        apiHandler.execute(Config.BOOKING_STATUS + bookingId, session.getToken());    }    private void drawRoute() {        if (!driverLat.equals("") && !driverLng.equals("")) {            fromPosition = new LatLng(Double.parseDouble(driverLat), Double.parseDouble(driverLng));            toPosition = new LatLng(Double.parseDouble(puLat), Double.parseDouble(puLng));            if (fromPosition != null && toPosition != null) {                googleMap.addMarker(new MarkerOptions()                        .position(fromPosition)                        .icon(BitmapDescriptorFactory.fromResource(R.drawable.red_dot)));                googleMap.addMarker(new MarkerOptions()                        .position(toPosition)                        .icon(BitmapDescriptorFactory.fromResource(R.drawable.green_dot)));                String url = getDirectionsUrl(fromPosition, null, toPosition);                DownloadTask downloadTask = new DownloadTask();                downloadTask.execute(url);            }        }    }    private void Prompt(final String title, String message) {        final com.bookmyride.views.AlertDialog mDialog = new com.bookmyride.views.AlertDialog(DriverArrived.this, true);        mDialog.setDialogTitle(title);        mDialog.setDialogMessage(message);        mDialog.setNegativeButton("YES", new View.OnClickListener() {            @Override            public void onClick(View v) {                mDialog.dismiss();                reCall("");            }        });        mDialog.setPositiveButton(getResources().getString(R.string.cancel), new View.OnClickListener() {            @Override            public void onClick(View view) {                mDialog.dismiss();            }        });        mDialog.show();    }    private void Alert(final String title, String message) {        final com.bookmyride.views.AlertDialog mDialog = new com.bookmyride.views.AlertDialog(DriverArrived.this, true);        mDialog.setDialogTitle(title);        mDialog.setDialogMessage(message);        mDialog.setPositiveButton(getResources().getString(R.string.ok), new View.OnClickListener() {            @Override            public void onClick(View v) {                mDialog.dismiss();                if (title.equals("Success!")) {                    goHome();                }            }        });        mDialog.show();    }    private void showNote(final String title, String message) {        final com.bookmyride.views.LinedAlertDialog mDialog = new com.bookmyride.views.LinedAlertDialog(DriverArrived.this, false, true);        mDialog.setDialogTitle(title);        mDialog.setDialogMessage(message);        mDialog.setPositiveButton("CLOSE", new View.OnClickListener() {            @Override            public void onClick(View v) {                mDialog.dismiss();            }        });        mDialog.show();    }    @Override    public void onProgressChanged(SeekBar seekBar, int i, boolean b) {    }    @Override    public void onStartTrackingTouch(SeekBar seekBar) {        slider.setVisibility(View.VISIBLE);    }    @Override    public void onStopTrackingTouch(SeekBar seekBar) {        //call api        if (seekBar.getProgress() > 90) {            sliderSeekBar.setProgress(2);            if (!driverLat.equals("") && !driverLng.equals("null")                    && !puLat.equals("") && !puLng.equals("null")) {                if (getRideDistance(Double.parseDouble(puLat),                        Double.parseDouble(puLng),                        Double.parseDouble(driverLat),                        Double.parseDouble(driverLng)) <= 2)                    driverArrived("3");                else {                    String msg = "Currently, You are too far from the pickup location. Please try again when you reach closer to the pickup location";                    Alert("Alert!", msg);                }            }        } else {            sliderSeekBar.setProgress(2);        }        updateSliderUI();    }    private void updateSliderUI() {        if (driverCategory.equals("1"))            sliderSeekBar.setThumb(getResources().getDrawable(R.drawable.slider_taxi));        else if (driverCategory.equals("2"))            sliderSeekBar.setThumb(getResources().getDrawable(R.drawable.slider_economy));        else if (driverCategory.equals("3"))            sliderSeekBar.setThumb(getResources().getDrawable(R.drawable.slider_premium));        else if (driverCategory.equals("4"))            sliderSeekBar.setThumb(getResources().getDrawable(R.drawable.slider_motor_bike));    }    @Override    public void onBackPressed() {        super.onBackPressed();    }    @Override    public boolean onTouch(View view, MotionEvent motionEvent) {        return false;    }    private void driverArrived(String status) {        type = 0;        HashMap<String, String> jsonParams = new HashMap<String, String>();        jsonParams.put("status", status);        if (Internet.hasInternet(this)) {            APIHandler apiHandler = new APIHandler(this, HTTPMethods.PUT, this, jsonParams);            apiHandler.execute(Config.BOOKING_STATUS + bookingId, session.getToken());        } else            Error("Alert!", getResources().getString(R.string.no_internet));    }    private void notifyPassenger(String status) {        HashMap<String, String> jsonParams = new HashMap<String, String>();        jsonParams.put("status", status);        if (Internet.hasInternet(this)) {            apiHandler = new APIHandler(this, HTTPMethods.PUT, new AsyncTaskCompleteListener() {                @Override                public void onTaskComplete(String result) {                    try {                        JSONObject outJson = new JSONObject(result);                        if (outJson.getInt(Key.STATUS) == APIStatus.SUCCESS) {                            notifiedPassenger = true;                        }                    } catch (JSONException e) {                        e.printStackTrace();                    }                }            }, jsonParams);            apiHandler.execute(Config.BOOKING_STATUS + bookingId, session.getToken());        } else            Error("Alert!", getResources().getString(R.string.no_internet));    }    @Override    public void onTaskComplete(String result) {        handleResponse(result);    }    private void handleResponse(String result) {        try {            JSONObject outJson = new JSONObject(result);            if (outJson.getInt(Key.STATUS) == APIStatus.SUCCESS) {                if (type == 0) {                    isDriverArrived = true;                    session.saveWaitingInfo(0L, 0L, 0L, 0L, 0, 0);                    startActivity(new Intent(DriverArrived.this, BeginRide.class)                            .putExtra("bookingId", bookingId)                            .putExtra("passenger_name", passengerName)                            .putExtra("passenger_phone", passengerPhone)                            .putExtra("type", bookingType)                            .putExtra("is_discount", getIntent().getBooleanExtra("is_discount", false))                            .putExtra("payment_status", paymentStatus)                            .putExtra("pickUp", getIntent().getStringExtra("pickUp"))                            .putExtra("driverCategory", getIntent().getStringExtra("driverCategory"))                            .putExtra("dropOff", getIntent().getStringExtra("dropOff")));                    overridePendingTransition(R.anim.fade_in, R.anim.fade_out);                    DriverArrived.this.finish();                } else if (type == 1) {                    Error("Success!", "Message has sent to driver.");                } else if (type == 2) {                    JSONObject dataObj = outJson.getJSONObject(Key.DATA);                    paymentStatus = dataObj.get("paymentStatus").toString();                    if (dataObj.has("note"))                        noteMsg = dataObj.get("note").toString();                    else noteMsg = "";                    noteMessage.setText(noteMsg);                    if (dataObj.has("paymentDetail")) {                        String paymentInfo = dataObj.get("paymentDetail").toString();                        if (!paymentInfo.equals("") && !paymentInfo.equals("null")) {                            JSONObject payObj = new JSONObject(paymentInfo);                            if (payObj.has("isCardValid"))                                cardValid = payObj.get("isCardValid").toString();                            else cardValid = "";                        }                    }                    String passengerInfo = dataObj.getString("passanger");                    if (!passengerInfo.equals("") && !passengerInfo.equals("null")) {                        JSONObject passengerObj = new JSONObject(passengerInfo);                        passengerName = passengerObj.getString("fullName");                        if (passengerObj.getString("dial_code").equals("null"))                            passengerPhone = passengerObj.getString("phone");                        else                            passengerPhone = passengerObj.getString("dial_code") + passengerObj.getString("phone");                    }                    if (!noteMsg.equals("") && !noteMsg.equals("null")) {                        note.setVisibility(View.VISIBLE);                    } else note.setVisibility(View.GONE);                    if (paymentStatus.equals("1")) {                        float scale = getResources().getDisplayMetrics().density;                        int dpAsPixels = (int) (10 * scale + 0.5f);                        pmtStatus.setPadding(dpAsPixels, dpAsPixels, dpAsPixels, dpAsPixels);                        pmtStatus.setVisibility(View.VISIBLE);                    } else pmtStatus.setVisibility(View.GONE);                    if (cardValid.equals("0")) {                        pmtStatus.setText("Credit Card Invalid");                        pmtStatus.setBackgroundResource(R.drawable.rounded_red);                        float scale = getResources().getDisplayMetrics().density;                        int dpAsPixels = (int) (10 * scale + 0.5f);                        pmtStatus.setPadding(dpAsPixels, dpAsPixels, dpAsPixels, dpAsPixels);                        pmtStatus.setVisibility(View.VISIBLE);                    } else pmtStatus.setVisibility(View.GONE);                    if (android.os.Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {                        if (checkLocationPermission())                            initializeMap();                    } else                        initializeMap();                } else if (type == 3) {                    String msg = "Your recall request has been updated successfully. Ride is available for other drivers now.";                    //Alert("Success!", msg);                    showReCallDialog();                } else if (type == 4) {                    String msg = "Your recall request has been updated successfully. Ride is available for other drivers now.";                    Alert("Success!", msg);                }            } else if (outJson.getInt(Key.STATUS) == APIStatus.SERVER_ERROR) {                Error("Alert!", outJson.getString(Key.MESSAGE));            } else if (outJson.getInt(Key.STATUS) == APIStatus.UNPROCESSABLE) {                Error("Alert!", outJson.getJSONArray(Key.DATA).getJSONObject(0).getString(Key.MESSAGE));                initSlider();            } else {                Error("Alert!", outJson.getString(Key.MESSAGE));            }        } catch (JSONException e) {            e.printStackTrace();            initSlider();        }    }    private void goHome() {        Intent intent = new Intent(getApplicationContext(), DriverHome.class);        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);        startActivity(intent);        overridePendingTransition(R.anim.fade_in, R.anim.fade_out);        DriverArrived.this.finish();    }    private void Error(String title, String message) {        final com.bookmyride.views.AlertDialog mDialog = new com.bookmyride.views.AlertDialog(DriverArrived.this, true);        mDialog.setDialogTitle(title);        mDialog.setDialogMessage(message);        mDialog.setPositiveButton(getResources().getString(R.string.ok), new View.OnClickListener() {            @Override            public void onClick(View v) {                mDialog.dismiss();            }        });        mDialog.show();    }    @Override    protected void onResume() {        super.onResume();        LocalBroadcastManager.getInstance(this).registerReceiver(mReceiver,                new IntentFilter(NotificationFilters.REQUEST_CANCELLED));        LocalBroadcastManager.getInstance(this).registerReceiver(mReceiver,                new IntentFilter(NotificationFilters.LOCATION_CHANGED));        NotificationUtils.clearNotifications(getApplicationContext());        /*if (mGoogleApiClient != null && mGoogleApiClient.isConnected() &&                ContextCompat.checkSelfPermission(this,                        Manifest.permission.ACCESS_FINE_LOCATION)                        == PackageManager.PERMISSION_GRANTED) {            LocationServices.FusedLocationApi.requestLocationUpdates(mGoogleApiClient, mLocationRequest, this);        } else {            initGoogleAPIClient();        }*/    }    @Override    protected void onPause() {        stopLocationUpdates();        LocalBroadcastManager.getInstance(this).unregisterReceiver(mReceiver);        super.onPause();    }    private void stopLocationUpdates() {        if (mGoogleApiClient != null && mGoogleApiClient.isConnected() &&                mLocationRequest != null) {            LocationServices.FusedLocationApi.removeLocationUpdates(mGoogleApiClient, this);        }    }    @Override    protected void onStart() {        if (mGoogleApiClient != null)            mGoogleApiClient.connect();        //startService(new Intent(this, RouteService.class));        super.onStart();        freeMemory();    }    public void freeMemory() {        System.runFinalization();        Runtime.getRuntime().gc();        System.gc();    }    @Override    protected void onStop() {        if (mGoogleApiClient != null)            mGoogleApiClient.disconnect();        super.onStop();    }    @Override    protected void onDestroy() {        stopLocationUpdates();        LocalBroadcastManager.getInstance(this).unregisterReceiver(mReceiver);        if (googleMap != null) {            googleMap.clear();            googleMap = null;        }        super.onDestroy();    }    public void showRideDialog() {        final Dialog mDialog = new Dialog(DriverArrived.this, R.style.rideDialog);        mDialog.setCancelable(false);        mDialog.requestWindowFeature(Window.FEATURE_NO_TITLE);        mDialog.getWindow().setBackgroundDrawable(new ColorDrawable(Color.TRANSPARENT));        mDialog.setContentView(R.layout.fragment_list);        mDialog.setCanceledOnTouchOutside(true);        TextView title = (TextView) mDialog.findViewById(R.id.title);        title.setVisibility(View.VISIBLE);        title.setText("Select Contact Type");        mDialog.setOnCancelListener(new DialogInterface.OnCancelListener() {            @Override            public void onCancel(DialogInterface dialog) {                mDialog.dismiss();            }        });        mDialog.setOnDismissListener(new DialogInterface.OnDismissListener() {            @Override            public void onDismiss(DialogInterface dialog) {                mDialog.dismiss();            }        });        ListView dialog_ListView = (ListView) mDialog.findViewById(R.id.list);        ArrayAdapter<String>                adapter = new ArrayAdapter<>(this,                R.layout.simple_list_item, R.id.textItem, getContactType());        dialog_ListView.setAdapter(adapter);        dialog_ListView.setOnItemClickListener(new AdapterView.OnItemClickListener() {            @Override            public void onItemClick(AdapterView<?> parent, View view,                                    int position, long id) {                if (parent.getItemAtPosition(position).toString().equals("SMS")) {                    showMessageDialog();                } else if (parent.getItemAtPosition(position).toString().equals("CALL")) {                    //callPassenger();                    getTwillioNumber();                }                mDialog.dismiss();            }        });        mDialog.show();    }    private void callPassenger() {        if (Build.VERSION.SDK_INT >= 23) {            // Marshmallow+            if (!checkCallPhonePermission() || !checkReadStatePermission()) {                requestPermission();            } else {                Intent callIntent = new Intent(Intent.ACTION_CALL);                callIntent.setData(Uri.parse("tel:" + passengerPhone));                startActivity(callIntent);            }        } else {            Intent callIntent = new Intent(Intent.ACTION_CALL);            callIntent.setData(Uri.parse("tel:" + passengerPhone));            startActivity(callIntent);        }    }    private boolean checkCallPhonePermission() {        int result = ContextCompat.checkSelfPermission(this, Manifest.permission.CALL_PHONE);        if (result == PackageManager.PERMISSION_GRANTED) {            return true;        } else {            return false;        }    }    private boolean checkReadStatePermission() {        int result = ContextCompat.checkSelfPermission(this, Manifest.permission.READ_PHONE_STATE);        if (result == PackageManager.PERMISSION_GRANTED) {            return true;        } else {            return false;        }    }    private void requestPermission() {        ActivityCompat.requestPermissions(this, new String[]{Manifest.permission.CALL_PHONE, Manifest.permission.READ_PHONE_STATE}, PERMISSION_REQUEST_CODE);    }    final int PERMISSION_REQUEST_CODE = 111;    private void showMessageDialog() {        LayoutInflater inflater = LayoutInflater.from(DriverArrived.this);        View subView = inflater.inflate(R.layout.message_dialog, null);        final EditText subEditText = (EditText) subView.findViewById(R.id.bid_price);        TextView proceed = (TextView) subView.findViewById(R.id.send);        TextView cancel = (TextView) subView.findViewById(R.id.cancel);        AlertDialog.Builder builder = new AlertDialog.Builder(DriverArrived.this);        builder.setView(subView);        final AlertDialog alertDialog = builder.create();        proceed.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                if (subEditText.getText().toString().length() > 0) {                    alertDialog.dismiss();                    sendMessageToDriver(subEditText.getText().toString());                } else                    Error("Alert!", "Please enter message.");            }        });        cancel.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                alertDialog.dismiss();            }        });        alertDialog.show();    }    int type;    private void sendMessageToDriver(String message) {        type = 1;        HashMap<String, String> params = new HashMap<String, String>();        params.put("msgFrom", session.getUserID());        params.put("msgTo", passengerPhone);        params.put("booking_id", bookingId);        params.put("msg", message);        APIHandler apiHandler = new APIHandler(this, HTTPMethods.POST, this, params);        apiHandler.execute(Config.SEND_MESSAGE_DRIVER, session.getToken());    }    public String[] getContactType() {        String[] gateway = getResources().getStringArray(R.array.contact_via);        return gateway;    }    private String getDirectionsUrl(LatLng origin, LatLng wayPoint, LatLng dest) {        // Origin of route        String str_origin = "origin=" + origin.latitude + "," + origin.longitude;        String str_dest = "destination=" + dest.latitude + "," + dest.longitude;        // Sensor enabled        String sensor = "sensor=false";        // Building the parameters to the web service        String parameters;        if (wayPoint != null) {            String wayPoints = "waypoints=optimize:true|" + wayPoint.latitude + "," + wayPoint.longitude + "|";            parameters = str_origin + "&" + wayPoints + "&" + str_dest + "&" + sensor;        } else {            parameters = str_origin + "&" + str_dest + "&" + sensor;        }        String mode = "mode=driving&transit_routing_preference=less_driving&";        // Output format        String output = "json";        // Building the url to the web service        String url = "https://maps.googleapis.com/maps/api/directions/" + output + "?" + mode + parameters + "&key=" + Config.PLACE_API;        return url;    }    /**     * A method to download json data from url     */    private String downloadUrl(String strUrl) throws IOException {        String data = "";        InputStream iStream = null;        HttpURLConnection urlConnection = null;        try {            URL url = new URL(strUrl);            // Creating an http connection to communicate with url            urlConnection = (HttpURLConnection) url.openConnection();            // Connecting to url            urlConnection.connect();            // Reading data from url            iStream = urlConnection.getInputStream();            BufferedReader br = new BufferedReader(new InputStreamReader(iStream));            StringBuffer sb = new StringBuffer();            String line = "";            while ((line = br.readLine()) != null) {                sb.append(line);            }            data = sb.toString();            br.close();        } catch (Exception e) {            e.printStackTrace();        } finally {            iStream.close();            urlConnection.disconnect();        }        return data;    }    /**     * A class to download data from Google Directions URL     */    private class DownloadTask extends AsyncTask<String, Void, String> {        // Downloading data in non-ui thread        @Override        protected String doInBackground(String... url) {            // For storing data from web service            String data = "";            try {                // Fetching the data from web service                data = downloadUrl(url[0]);            } catch (Exception e) {                e.printStackTrace();            }            return data;        }        // Executes in UI thread, after the execution of doInBackground()        @Override        protected void onPostExecute(String result) {            super.onPostExecute(result);            Log.e("re", result);            ParserTask parserTask = new ParserTask();            // Invokes the thread for parsing the JSON data            parserTask.execute(result);        }    }    /**     * A class to parse the Google Directions in JSON format     */    private class ParserTask extends AsyncTask<String, Integer, List<List<HashMap<String, String>>>> {        // Parsing the data in non-ui thread        @Override        protected List<List<HashMap<String, String>>> doInBackground(String... jsonData) {            JSONObject jObject;            List<List<HashMap<String, String>>> routes = null;            try {                jObject = new JSONObject(jsonData[0]);                DirectionsJSONParser parser = new DirectionsJSONParser();                // Starts parsing data                routes = parser.parse(jObject);            } catch (Exception e) {                e.printStackTrace();            }            return routes;        }        // Executes in UI thread, after the parsing process        @Override        protected void onPostExecute(List<List<HashMap<String, String>>> result) {            if (line != null) {                line.remove();            }            ArrayList<LatLng> points = null;            PolylineOptions lineOptions = null;            // Traversing through all the routes            for (int i = 0; i < result.size(); i++) {                points = new ArrayList<LatLng>();                lineOptions = new PolylineOptions();                // Fetching i-th route                List<HashMap<String, String>> path = result.get(i);                // Fetching all the points in i-th route                for (int j = 0; j < path.size(); j++) {                    HashMap<String, String> point = path.get(j);                    double lat = Double.parseDouble(point.get("lat"));                    double lng = Double.parseDouble(point.get("lng"));                    LatLng position = new LatLng(lat, lng);                    points.add(position);                }                // Adding all the points in the route to LineOptions                lineOptions.geodesic(true);                lineOptions.addAll(points);                lineOptions.width(10);                lineOptions.color(Color.RED);            }            try {                // Drawing polyline in the Google Map for the i-th route                line = googleMap.addPolyline(lineOptions);                LatLngBounds.Builder bc = new LatLngBounds.Builder();                for (LatLng item : points) {                    bc.include(item);                }                googleMap.animateCamera(CameraUpdateFactory.newLatLngBounds(bc.build(), 50));            } catch (NullPointerException e) {                e.printStackTrace();            }        }    }    public static final int MY_PERMISSIONS_REQUEST_LOCATION = 99;    public boolean checkLocationPermission() {        if (ContextCompat.checkSelfPermission(this,                Manifest.permission.ACCESS_FINE_LOCATION)                != PackageManager.PERMISSION_GRANTED) {            if (ActivityCompat.shouldShowRequestPermissionRationale(this,                    Manifest.permission.ACCESS_FINE_LOCATION)) {                ActivityCompat.requestPermissions(this,                        new String[]{Manifest.permission.ACCESS_FINE_LOCATION},                        MY_PERMISSIONS_REQUEST_LOCATION);            } else {                // No explanation needed, we can request the permission.                ActivityCompat.requestPermissions(this,                        new String[]{Manifest.permission.ACCESS_FINE_LOCATION},                        MY_PERMISSIONS_REQUEST_LOCATION);            }            return false;        } else {            return true;        }    }    @Override    public void onRequestPermissionsResult(int requestCode,                                           String permissions[], int[] grantResults) {        switch (requestCode) {            case MY_PERMISSIONS_REQUEST_LOCATION:                if (grantResults.length > 0                        && grantResults[0] == PackageManager.PERMISSION_GRANTED) {                    if (ContextCompat.checkSelfPermission(this,                            Manifest.permission.ACCESS_FINE_LOCATION)                            == PackageManager.PERMISSION_GRANTED) {                        googleMap.setMyLocationEnabled(false);                        googleMap.getUiSettings().setMyLocationButtonEnabled(false);                        initializeMap();                    }                } else {                    Toast.makeText(this, "Permission denied.", Toast.LENGTH_LONG).show();                }                break;            case PERMISSION_REQUEST_CODE:                if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {                    /*if(sPhoneMasking_Status.equalsIgnoreCase("Yes")) {                        postRequest_PhoneMasking(Iconstant.phone_masking_url);                    } else {                        Intent callIntent = new Intent(Intent.ACTION_CALL);                        callIntent.setData(Uri.parse("tel:" + driverMobile));                        startActivity(callIntent);                    }*/                }                break;        }    }    protected synchronized void buildGoogleApiClient() {        mGoogleApiClient = new GoogleApiClient.Builder(this)                .addConnectionCallbacks(this)                .addOnConnectionFailedListener(this)                .addApi(LocationServices.API)                .build();        //mGoogleApiClient.connect();    }    private Location mLastLocation;    @Override    public void onConnected(Bundle bundle) {        mLocationRequest = new LocationRequest();        /*mLocationRequest.setInterval(3000);        mLocationRequest.setFastestInterval(16);*/        mLocationRequest.setInterval(INTERVAL);        mLocationRequest.setFastestInterval(FASTEST_INTERVAL);        //mLocationRequest.setSmallestDisplacement(0.1f);        mLocationRequest.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);        if (android.os.Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {            if (ContextCompat.checkSelfPermission(this,                    Manifest.permission.ACCESS_FINE_LOCATION)                    == PackageManager.PERMISSION_GRANTED)                mLastLocation = LocationServices.FusedLocationApi.getLastLocation(mGoogleApiClient);            if (mLastLocation != null) {                latitude = mLastLocation.getLatitude();                longitude = mLastLocation.getLongitude();            }            LocationServices.FusedLocationApi.requestLocationUpdates(mGoogleApiClient, mLocationRequest, this);        } else {            mLastLocation = LocationServices.FusedLocationApi.getLastLocation(mGoogleApiClient);            if (mLastLocation != null) {                latitude = mLastLocation.getLatitude();                longitude = mLastLocation.getLongitude();            }            LocationServices.FusedLocationApi.requestLocationUpdates(mGoogleApiClient, mLocationRequest, this);        }    }    @Override    public void onConnectionFailed(@NonNull ConnectionResult connectionResult) {    }    @Override    public void onConnectionSuspended(int i) {    }    @Override    public void onLocationChanged(Location location) {        Log.e("driver_arrived", "loc changed");        latitude = location.getLatitude();        longitude = location.getLongitude();        if (line == null && googleMap != null) {            driverLat = "" + latitude;            driverLng = "" + longitude;            drawRoute();        }        if (!notifiedPassenger && apiHandler == null) {            double driverDistance = getRideDistance(location.getLatitude(),                    location.getLongitude(),                    Double.parseDouble(puLat),                    Double.parseDouble(puLng));            if (driverDistance <= 2) {                new Handler().postDelayed(new Runnable() {                    @Override                    public void run() {                        notifyPassenger("12");                    }                }, 2000);            }        }        if (!isDriverArrived) {            if (getDistanceInMeters(location, Double.parseDouble(puLat),                    Double.parseDouble(puLng)) < 100) {                stopLocationUpdates();                new Handler().postDelayed(new Runnable() {                    @Override                    public void run() {                        driverArrived("3");                    }                }, 5000);                return;            }        }        Log.e("driver_loc", location.getAccuracy() + "<>" + location.getSpeed());        //if (location.getAccuracy() < 100.0 && location.getSpeed() < 6.95) {            //Place current location marker            LatLng latLng = new LatLng(location.getLatitude(), location.getLongitude());            if (googleMap != null) {                if (mCurrLocationMarker == null) {                    drawMarker(latLng);                } else {                    updateMarker(latLng);                    //googleMap.moveCamera(CameraUpdateFactory.newLatLng(latLng));                    zoomLevel = googleMap.getCameraPosition().zoom;                    if (zoomLevel < 12)                        zoomLevel = 15;                    CameraUpdate loc = CameraUpdateFactory.newLatLngZoom(                            latLng, zoomLevel);                    googleMap.animateCamera(loc);                }            }            if (line != null) {                double tolerance = 50;                boolean isLocationOnPath = PolyUtil.isLocationOnEdge(latLng, line.getPoints(), true, tolerance);                if (!isLocationOnPath) {                    //Toast.makeText(getApplicationContext(), "Updating Route", Toast.LENGTH_SHORT).show();                    String url = getDirectionsUrl(fromPosition, latLng, toPosition);                    DownloadTask downloadTask = new DownloadTask();                    downloadTask.execute(url);                }            }        //}    }    boolean notifiedPassenger = false;    boolean isDriverArrived = false;    //Finding distance in meters between two locations.    private float getDistanceInMeters(Location loc1, double puLat, double puLng) {        Location loc2 = new Location("");        loc2.setLatitude(puLat);        loc2.setLongitude(puLng);        float distInMeter = loc1.distanceTo(loc2);        return distInMeter;    }    Polyline line = null;    private void updateMarker(LatLng position) {        //mCurrLocationMarker.setPosition(position);        Location currLoc = new Location("curr");        currLoc.setLatitude(position.latitude);        currLoc.setLongitude(position.longitude);        if (prevLat == 0.0 && prevLng == 0.0) {            prevLat = position.latitude;            prevLng = position.longitude;        }        Location prevLoc = new Location("prev");        prevLoc.setLatitude(prevLat);        prevLoc.setLongitude(prevLng);        animateMarker(prevLoc, currLoc, mCurrLocationMarker);        //animateMarker(currLoc, mCurrLocationMarker);        prevLat = position.latitude;        prevLng = position.longitude;    }    double prevLat = 0.0, prevLng = 0.0;    private void drawMarker(LatLng position) {        int resource;        if (driverCategory.equals("4"))            resource = R.drawable.motor_bike_nav;        else if (driverCategory.equals("1"))            resource = R.drawable.taxi_nav;        else if (driverCategory.equals("3"))            resource = R.drawable.premium_nav;        else if (driverCategory.equals("2"))            resource = R.drawable.economy_nav;        else            resource = R.drawable.taxi_nav;        MarkerOptions markerOptions = new MarkerOptions().position(position)                .icon(BitmapDescriptorFactory.fromResource(resource))                .anchor(0.5f, 0.5f).flat(true);        mCurrLocationMarker = googleMap.addMarker(markerOptions);        //CameraUpdate cameraUpdate = CameraUpdateFactory.newLatLngZoom(position, 12);        //googleMap.animateCamera(cameraUpdate);    }    public static void animateMarker(final Location destination, final Marker marker) {        if (marker != null) {            final LatLng startPosition = marker.getPosition();            final LatLng endPosition = new LatLng(destination.getLatitude(), destination.getLongitude());            final float startRotation = marker.getRotation();            final LatLngInterpolator latLngInterpolator = new LatLngInterpolator.LinearFixed();            ValueAnimator valueAnimator = ValueAnimator.ofFloat(0, 1);            valueAnimator.setDuration(1000); // duration 1 second            valueAnimator.setInterpolator(new LinearInterpolator());            valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {                @Override                public void onAnimationUpdate(ValueAnimator animation) {                    try {                        float v = animation.getAnimatedFraction();                        LatLng newPosition = latLngInterpolator.interpolate(v, startPosition, endPosition);                        marker.setPosition(newPosition);                        marker.setRotation(computeRotation(v, startRotation, destination.getBearing()));                    } catch (Exception ex) {                        // I don't care atm..                    }                }            });            valueAnimator.start();        }    }    private static float computeRotation(float fraction, float start, float end) {        float normalizeEnd = end - start; // rotate start to 0        float normalizedEndAbs = (normalizeEnd + 360) % 360;        float direction = (normalizedEndAbs > 180) ? -1 : 1; // -1 = anticlockwise, 1 = clockwise        float rotation;        if (direction > 0) {            rotation = normalizedEndAbs;        } else {            rotation = normalizedEndAbs - 360;        }        float result = fraction * rotation + start;        return (result + 360) % 360;    }    public void animateMarker(final Location prevLoc, final Location currLoc, final Marker marker) {        if (marker != null && currLoc != null) {            final LatLng startPosition = marker.getPosition();            final LatLng endPosition = new LatLng(currLoc.getLatitude(), currLoc.getLongitude());            final float startRotation = marker.getRotation();            final LatLngInterpolator latLngInterpolator = new LatLngInterpolator.LinearFixed();            ValueAnimator valueAnimator = ValueAnimator.ofFloat(0, 1);            valueAnimator.setDuration(3000); // duration 3 second            valueAnimator.setInterpolator(new LinearInterpolator());            valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {                @Override                public void onAnimationUpdate(ValueAnimator animation) {                    try {                        float v = animation.getAnimatedFraction();                        LatLng newPosition = latLngInterpolator.interpolate(v, startPosition, endPosition);                        marker.setPosition(newPosition);                        //marker.setRotation(computeRotation(v, startRotation, destination.getBearing()));                        marker.setFlat(true);                        float bearing = (float) bearingBetweenLocations(                                new LatLng(prevLoc.getLatitude(), prevLoc.getLongitude())                                , new LatLng(currLoc.getLatitude(), currLoc.getLongitude()));                        rotateMarker(marker, bearing);                    } catch (Exception ex) {                        // I don't care atm..                    }                }            });            valueAnimator.start();            /*final LatLng endPosition = new LatLng(currLoc.getLatitude(), currLoc.getLongitude());            final LatLngInterpolator latLngInterpolator = new LatLngInterpolator.LinearFixed();            ValueAnimator valueAnimator = new ValueAnimator();            //final LatLng startPosition = marker.getPosition();            final LatLng startPosition = new LatLng(prevLoc.getLatitude(), prevLoc.getLongitude());            valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {                @Override                public void onAnimationUpdate(ValueAnimator animation) {                    try {                        float v = animation.getAnimatedFraction();                        LatLng newPosition = latLngInterpolator.interpolate(v, startPosition, endPosition);                        marker.setPosition(newPosition);                        marker.setFlat(true);                        float bearing = (float) bearingBetweenLocations(                                new LatLng(prevLoc.getLatitude(), prevLoc.getLongitude())                                , new LatLng(currLoc.getLatitude(), currLoc.getLongitude()));                        rotateMarker(marker, bearing);                    } catch (Exception ex) {                        // I don't care atm..                        ex.printStackTrace();                    }                }            });            valueAnimator.setFloatValues(0, 1);            valueAnimator.setDuration(300);            valueAnimator.start();*/        }    }    boolean isMarkerRotating = false;    private double bearingBetweenLocations(LatLng previousLatLng, LatLng newLatLng) {        double PI = 3.14159;        double lat1 = previousLatLng.latitude * PI / 180;        double long1 = previousLatLng.longitude * PI / 180;        double lat2 = newLatLng.latitude * PI / 180;        double long2 = newLatLng.longitude * PI / 180;        double dLon = (long2 - long1);        double y = Math.sin(dLon) * Math.cos(lat2);        double x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1)                * Math.cos(lat2) * Math.cos(dLon);        double brng = Math.atan2(y, x);        brng = Math.toDegrees(brng);        brng = (brng + 360) % 360;        return brng;    }    private void rotateMarker(final Marker marker, final float toRotation) {        if (!isMarkerRotating) {            final Handler handler = new Handler();            final long start = SystemClock.uptimeMillis();            final float startRotation = marker.getRotation();            final long duration = 2000;            final Interpolator interpolator = new LinearInterpolator();            handler.post(new Runnable() {                @Override                public void run() {                    isMarkerRotating = true;                    long elapsed = SystemClock.uptimeMillis() - start;                    float t = interpolator.getInterpolation((float) elapsed / duration);                    float rot = t * toRotation + (1 - t) * startRotation;                    float bearing = -rot > 180 ? rot / 2 : rot;                    marker.setRotation(bearing);                    if (t < 1.0) {                        // Post again 16ms later.                        handler.postDelayed(this, 16);                    } else {                        isMarkerRotating = false;                    }                }            });        }    }    //Getting distance in kilometers (km)    public static double getRideDistance(            double lat1, double lng1, double lat2, double lng2) {        int r = 6371; // average radius of the earth in km        double dLat = Math.toRadians(lat2 - lat1);        double dLon = Math.toRadians(lng2 - lng1);        double a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +                Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2))                        * Math.sin(dLon / 2) * Math.sin(dLon / 2);        double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));        double d = r * c;        return d;    }    public void openGoogleMap(View view) {        boolean isAppInstalled = appInstalledOrNot("com.waze");        if (isAppInstalled)            navigationPrompt("Alert!", "Please choose preferred navigation app:");        else openGoogleMap(puLat, puLng);    }    private boolean appInstalledOrNot(String uri) {        PackageManager pm = getPackageManager();        try {            pm.getPackageInfo(uri, PackageManager.GET_ACTIVITIES);            PackageInfo appInfo = pm.getPackageInfo(uri, PackageManager.GET_ACTIVITIES);            return true;        } catch (PackageManager.NameNotFoundException e) {            e.printStackTrace();        }        return false;    }    private void openGoogleMap(String puLat, String puLng) {        Intent intent = new Intent(Intent.ACTION_VIEW,                Uri.parse("google.navigation:q=" + puLat + "," + puLng));        intent.setPackage("com.google.android.apps.maps");        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);        startActivity(intent);    }    // Launch Waze to look for Navigation    private void openWazeApp(String puLat, String puLng) {        try {            //String url = "geo: " + puLat + "," + puLng;            String url = "https://waze.com/ul?ll=" + puLat + "," + puLng + "&navigate=yes";            Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse(url));            startActivity(intent);        } catch (ActivityNotFoundException ex) {            Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse("market://details?id=com.waze"));            startActivity(intent);        }    }    private void navigationPrompt(String title, String message) {        final com.bookmyride.views.AlertDialog mDialog = new com.bookmyride.views.AlertDialog(DriverArrived.this, true);        mDialog.setDialogTitle(title);        mDialog.setDialogMessage(message);        mDialog.setNegativeButton("Proceed with Google",                new View.OnClickListener() {                    @Override                    public void onClick(View v) {                        mDialog.dismiss();                        openGoogleMap(puLat, puLng);                    }                });        mDialog.setPositiveButton("Proceed with Waze",                new View.OnClickListener() {                    @Override                    public void onClick(View v) {                        mDialog.dismiss();                        openWazeApp(puLat, puLng);                    }                });        mDialog.show();    }}